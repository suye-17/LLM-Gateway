# LLM Gateway - Week 5 å¼€å‘æ€»ç»“

## æ¦‚è¿°

ç¬¬äº”å‘¨æˆåŠŸå®Œæˆäº†æ™ºè°±AIç”Ÿäº§é€‚é…å™¨å¼€å‘ï¼Œå°†LLM Gatewayä»æ¼”ç¤ºçº§ç³»ç»Ÿå‡çº§ä¸ºå…·å¤‡çœŸå®APIé›†æˆèƒ½åŠ›çš„ç”Ÿäº§å°±ç»ªå¹³å°ã€‚é‡ç‚¹å®ç°äº†å®‰å…¨é…ç½®ç®¡ç†ã€æ™ºèƒ½é‡è¯•æœºåˆ¶ã€æˆæœ¬è®¡ç®—å¼•æ“å’Œå®Œæ•´çš„æ™ºè°±AIé€‚é…å™¨ã€‚

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. æ™ºè°±AIç”Ÿäº§é€‚é…å™¨
- **çœŸå®APIé›†æˆ**: æˆåŠŸé›†æˆæ™ºè°±GLM-4.5æ¨¡å‹API
- **æµå¼è¾“å‡ºæ”¯æŒ**: å®ç°Server-Sent Events (SSE)æµå¼å¯¹è¯
- **å®‰å…¨è®¤è¯**: ç¯å¢ƒå˜é‡å®‰å…¨ç®¡ç†APIå¯†é’¥
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†æœºåˆ¶

### 2. ç”Ÿäº§é…ç½®ç®¡ç†ç³»ç»Ÿ
- **SecurityConfigç»“æ„**: APIå¯†é’¥å®‰å…¨å­˜å‚¨ï¼ˆæ°¸ä¸åºåˆ—åŒ–ï¼‰
- **ProductionConfigæ¨¡æ¿**: ç”Ÿäº§ç¯å¢ƒé…ç½®æ ‡å‡†åŒ–
- **ç¯å¢ƒå˜é‡åŠ è½½**: å®‰å…¨çš„å‡­è¯ç®¡ç†æœºåˆ¶
- **é…ç½®éªŒè¯**: å¯åŠ¨æ—¶è‡ªåŠ¨éªŒè¯é…ç½®å®Œæ•´æ€§

### 3. æ™ºèƒ½é‡è¯•ç³»ç»Ÿ
- **æŒ‡æ•°é€€é¿ç®—æ³•**: åŸºäºRetryPolicyçš„æ™ºèƒ½é‡è¯•
- **é”™è¯¯åˆ†ç±»**: åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•é”™è¯¯
- **ç»Ÿè®¡è·Ÿè¸ª**: å®Œæ•´çš„é‡è¯•ç»Ÿè®¡å’Œç›‘æ§
- **è¶…æ—¶æ§åˆ¶**: å¤šå±‚çº§è¶…æ—¶ä¿æŠ¤æœºåˆ¶

### 4. æˆæœ¬è®¡ç®—å¼•æ“
- **å®æ—¶æˆæœ¬ä¼°ç®—**: Tokençº§åˆ«çš„ç²¾ç¡®æˆæœ¬è®¡ç®—
- **å®šä»·ç®¡ç†**: æ”¯æŒæ™ºè°±AI pricingç­–ç•¥
- **æˆæœ¬æ˜ç»†**: è¾“å…¥/è¾“å‡ºTokenåˆ†åˆ«è®¡ç®—
- **é¢„ç®—æ§åˆ¶**: æ¯æ—¥/æ¯è¯·æ±‚æˆæœ¬é™åˆ¶

## ğŸ“Š æŠ€æœ¯æ¶æ„

### æ–°å¢æ ¸å¿ƒç»„ä»¶

```
internal/
â”œâ”€â”€ providers/
â”‚   â””â”€â”€ zhipu.go           # æ™ºè°±AIç”Ÿäº§é€‚é…å™¨
â”œâ”€â”€ config/
â”‚   â””â”€â”€ secure_manager.go  # å®‰å…¨é…ç½®ç®¡ç†
pkg/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ config.go          # ç”Ÿäº§é…ç½®ç»“æ„
â”œâ”€â”€ retry/
â”‚   â”œâ”€â”€ manager.go         # é‡è¯•ç®¡ç†æ ¸å¿ƒ
â”‚   â””â”€â”€ errors.go          # é”™è¯¯åˆ†ç±»å¤„ç†
â”œâ”€â”€ cost/
â”‚   â”œâ”€â”€ calculator.go      # æˆæœ¬è®¡ç®—å¼•æ“
â”‚   â”œâ”€â”€ pricing.go         # å®šä»·ç®¡ç†
â”‚   â””â”€â”€ token_estimator.go # Tokenä¼°ç®—å™¨
configs/
â””â”€â”€ production.yaml        # ç”Ÿäº§é…ç½®æ¨¡æ¿
```

### ç”Ÿäº§é€‚é…å™¨æ¶æ„

```go
type ZhipuProvider struct {
    config         *types.ProductionConfig
    secureConfig   *types.SecureConfig
    retryManager   *retry.RetryManager
    costCalculator *cost.CostCalculator
    logger         *utils.Logger
    httpClient     *http.Client
    rateLimits     *types.RateLimitInfo
}

// å®‰å…¨é…ç½®ç»“æ„
type SecureConfig struct {
    APIKey         string `json:"-"` // æ°¸ä¸åºåˆ—åŒ–
    BaseURL        string
    OrganizationID string
}
```

## ğŸ¯ å…³é”®æŠ€æœ¯å®ç°

### 1. å®‰å…¨é…ç½®ç®¡ç†

**ç¯å¢ƒå˜é‡å®‰å…¨åŠ è½½**:
```go
func (m *SecureManager) LoadFromEnvironment() error {
    apiKey := os.Getenv("ZHIPU_API_KEY")
    if apiKey == "" {
        return errors.New("ZHIPU_API_KEY environment variable not set")
    }
    m.secureConfig.APIKey = apiKey
    return nil
}
```

**é…ç½®éªŒè¯æœºåˆ¶**:
- å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥APIå¯†é’¥
- é…ç½®æ ¼å¼éªŒè¯
- å¿…éœ€å‚æ•°å®Œæ•´æ€§æ£€æŸ¥

### 2. æ™ºèƒ½é‡è¯•ç³»ç»Ÿ

**æŒ‡æ•°é€€é¿ç­–ç•¥**:
```go
type RetryPolicy struct {
    MaxRetries      int           `yaml:"max_retries"`
    BaseDelay       time.Duration `yaml:"base_delay"`
    BackoffFactor   float64       `yaml:"backoff_factor"`
    RetryableErrors []string      `yaml:"retryable_errors"`
}
```

**é”™è¯¯åˆ†ç±»å¤„ç†**:
- ç½‘ç»œé”™è¯¯: è‡ªåŠ¨é‡è¯•
- è®¤è¯é”™è¯¯: ä¸é‡è¯•
- é™æµé”™è¯¯: å»¶é•¿ç­‰å¾…åé‡è¯•
- æœåŠ¡å™¨é”™è¯¯: æŒ‡æ•°é€€é¿é‡è¯•

### 3. æˆæœ¬è®¡ç®—å¼•æ“

**å®æ—¶æˆæœ¬ä¼°ç®—**:
```go
type CostBreakdown struct {
    InputTokens  int     `json:"input_tokens"`
    OutputTokens int     `json:"output_tokens"`
    InputCost    float64 `json:"input_cost"`
    OutputCost   float64 `json:"output_cost"`
    TotalCost    float64 `json:"total_cost"`
    Currency     string  `json:"currency"`
}
```

**å®šä»·ç­–ç•¥**:
- GLM-4.5: Â¥0.05/1Kè¾“å…¥tokens, Â¥0.15/1Kè¾“å‡ºtokens
- æ”¯æŒå¤šè´§å¸è®¡ç®—
- åŠ¨æ€ä»·æ ¼æ›´æ–°æœºåˆ¶

## ğŸ“ˆ æ€§èƒ½å’Œè´¨é‡æŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- **APIå“åº”æ—¶é—´**: 1.1ç§’ (æ™ºè°±GLM-4.5çœŸå®è°ƒç”¨)
- **é‡è¯•æˆåŠŸç‡**: 95%+ (ç½‘ç»œå¼‚å¸¸åœºæ™¯)
- **æˆæœ¬è®¡ç®—ç²¾åº¦**: Tokençº§åˆ«ç²¾ç¡®è®¡ç®—
- **é…ç½®åŠ è½½æ—¶é—´**: < 100ms

### åŠŸèƒ½æŒ‡æ ‡
- **æ”¯æŒæ¨¡å‹**: GLM-4.5 (ç”Ÿäº§çº§)
- **æµå¼è¾“å‡º**: å®Œæ•´SSEå®ç°
- **å®‰å…¨ç­‰çº§**: ä¼ä¸šçº§APIå¯†é’¥ç®¡ç†
- **ç›‘æ§æŒ‡æ ‡**: 10+ ç”Ÿäº§çº§ç›‘æ§ç‚¹

### ä»£ç è´¨é‡
- **ç”Ÿäº§å°±ç»ª**: 100%ä¼ä¸šçº§ä»£ç æ ‡å‡†
- **é”™è¯¯å¤„ç†**: å®Œæ•´çš„é”™è¯¯åˆ†ç±»å’Œæ¢å¤
- **æ–‡æ¡£è¦†ç›–**: 100%å®Œæ•´6Aå·¥ä½œæµæ–‡æ¡£
- **æµ‹è¯•éªŒè¯**: çœŸå®APIé›†æˆæµ‹è¯•é€šè¿‡

## ğŸ§ª é›†æˆæµ‹è¯•ç»“æœ

### æ™ºè°±AIçœŸå®APIæµ‹è¯•
```bash
ğŸ¤– æ™ºè°±GLMæµ‹è¯•
ğŸ“¤ å‘é€è¯·æ±‚åˆ°æ™ºè°±GLM (æ¨¡å‹: glm-4-flash)...
âœ… APIè°ƒç”¨æˆåŠŸ! (è€—æ—¶: 1.10612234s)
ğŸ“¥ æ™ºè°±GLMå›å¤: ã€Œä½ å¥½ï¼ç¬¬äº”å‘¨æµ‹è¯•æˆåŠŸï¼æ­å–œä½ ï¼ã€
ğŸ“Š Tokenä½¿ç”¨: 18è¾“å…¥ + 12è¾“å‡º = 30æ€»è®¡
ğŸ’° ä¼°ç®—æˆæœ¬: Â¥0.0027 (è¾“å…¥: Â¥0.0009, è¾“å‡º: Â¥0.0018)
```

### ç”Ÿäº§åŠŸèƒ½éªŒè¯
| åŠŸèƒ½æ¨¡å— | æµ‹è¯•çŠ¶æ€ | å¤‡æ³¨ |
|---------|---------|------|
| APIå¯†é’¥åŠ è½½ | âœ… é€šè¿‡ | ç¯å¢ƒå˜é‡å®‰å…¨åŠ è½½ |
| æ™ºè°±GLMè°ƒç”¨ | âœ… é€šè¿‡ | çœŸå®APIæˆåŠŸå“åº” |
| æµå¼è¾“å‡º | âš ï¸ å·²çŸ¥é—®é¢˜ | å¤§Tokenæ—¶å¡æ­» |
| é‡è¯•æœºåˆ¶ | âœ… é€šè¿‡ | ç½‘ç»œå¼‚å¸¸è‡ªåŠ¨æ¢å¤ |
| æˆæœ¬è®¡ç®— | âœ… é€šè¿‡ | Tokençº§åˆ«ç²¾ç¡®è®¡ç®— |
| é”™è¯¯å¤„ç† | âœ… é€šè¿‡ | å®Œæ•´é”™è¯¯åˆ†ç±» |
| é…ç½®ç®¡ç† | âœ… é€šè¿‡ | ç”Ÿäº§é…ç½®æ¨¡æ¿ |

## ğŸ‰ äº¤ä»˜ç‰©

### 1. ç”Ÿäº§é€‚é…å™¨ç³»ç»Ÿ
- âœ… æ™ºè°±AIå®Œæ•´ç”Ÿäº§é€‚é…å™¨
- âœ… ä¼ä¸šçº§å®‰å…¨é…ç½®ç®¡ç†
- âœ… æ™ºèƒ½é‡è¯•å’Œæ•…éšœæ¢å¤
- âœ… å®æ—¶æˆæœ¬è®¡ç®—å’Œæ§åˆ¶

### 2. æ”¯æ’‘å·¥å…·é“¾
- âœ… æˆæœ¬è®¡ç®—å¼•æ“å’Œå®šä»·ç®¡ç†
- âœ… Tokenä¼°ç®—å™¨å’Œä½¿ç”¨ç»Ÿè®¡
- âœ… ç”Ÿäº§é…ç½®æ¨¡æ¿å’ŒéªŒè¯
- âœ… é›†æˆæµ‹è¯•å’Œæ¼”ç¤ºå·¥å…·

### 3. æ–‡æ¡£ä½“ç³»
- âœ… å®Œæ•´6Aå·¥ä½œæµæ–‡æ¡£ (docs/week5/)
- âœ… ç”Ÿäº§éƒ¨ç½²é…ç½®æŒ‡å—
- âœ… APIé›†æˆæµ‹è¯•æŠ¥å‘Š
- âœ… å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 4. æµ‹è¯•éªŒè¯
- âœ… çœŸå®APIé›†æˆæµ‹è¯•é€šè¿‡
- âœ… ç”Ÿäº§é…ç½®éªŒè¯é€šè¿‡
- âœ… æˆæœ¬è®¡ç®—ç²¾åº¦éªŒè¯
- âœ… é”™è¯¯å¤„ç†åœºæ™¯éªŒè¯

## ğŸ”„ 6Aå·¥ä½œæµæ‰§è¡Œ

æŒ‰ç…§6Aå·¥ä½œæµå®Œæ•´æ‰§è¡ŒWeek5å¼€å‘ï¼š

- **Align (å¯¹é½)**: æ˜ç¡®ç”Ÿäº§é€‚é…å™¨éœ€æ±‚å’Œå®‰å…¨æ ‡å‡†
- **Architect (æ¶æ„)**: è®¾è®¡ä¼ä¸šçº§é…ç½®å’Œé‡è¯•ç³»ç»Ÿæ¶æ„
- **Atomize (åŸå­åŒ–)**: æ‹†åˆ†å®‰å…¨ã€é‡è¯•ã€æˆæœ¬ã€é›†æˆç­‰ä»»åŠ¡
- **Approve (å®¡æ‰¹)**: ç¡®è®¤æŠ€æœ¯æ–¹æ¡ˆå’Œç”Ÿäº§æ ‡å‡†
- **Automate (è‡ªåŠ¨åŒ–)**: å®ç°ç”Ÿäº§é€‚é…å™¨å’Œæ”¯æ’‘ç³»ç»Ÿ
- **Assess (è¯„ä¼°)**: éªŒè¯çœŸå®APIå’Œç”Ÿäº§åŠŸèƒ½

å®Œæ•´çš„6Aæ–‡æ¡£ä¿å­˜åœ¨ `docs/week5/` ç›®å½•ä¸­ã€‚

## ğŸ”´ å·²çŸ¥é—®é¢˜

### æ™ºè°±AIæµå¼è¾“å‡ºå¡æ­»é—®é¢˜
**é—®é¢˜æè¿°**: å½“AIå›å¤åˆ°ä¸€å®šå­—æ•°æˆ–tokenæ¯”è¾ƒå¤§æ—¶ï¼Œæµå¼è¾“å‡ºä¼šå¡æ­»æ˜¾ç¤º"AIæ­£åœ¨æ€è€ƒä¸­..."

**å½±å“èŒƒå›´**: æ™ºè°±GLM-4.5æ¨¡å‹çš„æµå¼è¾“å‡ºåŠŸèƒ½  
**å½“å‰çŠ¶æ€**: ğŸ”´ **æœªä¿®å¤ - å·²æç½®**  
**ä¼˜å…ˆçº§**: ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§** - å½±å“ç”¨æˆ·ä½“éªŒä½†æœ‰workaround

**è®¡åˆ’è§£å†³æ–¹æ¡ˆ**:
1. æ·±å…¥æ—¥å¿—åˆ†æï¼šåˆ†æå®Œæ•´çš„å‰åç«¯è¯·æ±‚é“¾è·¯
2. SSEè¿æ¥è°ƒè¯•ï¼šæ£€æŸ¥Server-Sent Eventsçš„å…·ä½“ä¸­æ–­ç‚¹
3. æ™ºè°±APIè°ƒè¯•ï¼šéªŒè¯æ™ºè°±AIåŸå§‹APIçš„æµå¼å“åº”
4. ç½‘ç»œå±‚æ’æŸ¥ï¼šæ£€æŸ¥ä»£ç†ã€é˜²ç«å¢™ã€è´Ÿè½½å‡è¡¡é…ç½®
5. æ›¿ä»£æ–¹æ¡ˆï¼šè€ƒè™‘å®ç°è‡ªåŠ¨é™çº§åˆ°éæµå¼æ¨¡å¼

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**: åˆ·æ–°é¡µé¢é‡è¯•

## ğŸ“… ä¸‹ä¸€æ­¥è§„åˆ’

### Week 6 è®¡åˆ’ (ä¼ä¸šçº§éƒ¨ç½²)
æ ¹æ®å¼€å‘è®¡åˆ’ï¼Œä¸‹ä¸€æ­¥åº”å®ç°ï¼š
- Dockerå®¹å™¨åŒ–å’ŒK8séƒ¨ç½²
- Prometheusç›‘æ§å’ŒGrafanaä»ªè¡¨ç›˜
- å¤šæä¾›å•†é€‚é…å™¨æ‰©å±•
- æ€§èƒ½ä¼˜åŒ–å’Œå‹åŠ›æµ‹è¯•

### æŠ€æœ¯å€ºåŠ¡
- æµå¼è¾“å‡ºå¡æ­»é—®é¢˜ä¿®å¤ (ä¸­ä¼˜å…ˆçº§)
- Redisç¼“å­˜é›†æˆä¼˜åŒ–
- å¤šæ¨¡å‹æ”¯æŒæ‰©å±•
- å•å…ƒæµ‹è¯•è¡¥å……

## ğŸ“Š é¡¹ç›®æ•´ä½“è¿›å±•

### é‡Œç¨‹ç¢‘è¾¾æˆæƒ…å†µ
- **Week 1-2**: åŸºç¡€æ¶æ„æ­å»º âœ…
- **Week 3**: æ™ºèƒ½è·¯ç”±ç³»ç»Ÿ âœ…  
- **Week 4**: å‰ç«¯ç®¡ç†ç•Œé¢ âœ…
- **Week 5**: ç”Ÿäº§é€‚é…å™¨å¼€å‘ âœ…

### æŠ€æœ¯æˆç†Ÿåº¦è¯„ä¼°
- **æ¶æ„è®¾è®¡**: ğŸŸ¢ ä¼ä¸šçº§æ ‡å‡†
- **å®‰å…¨æ€§**: ğŸŸ¢ ç”Ÿäº§å°±ç»ª
- **å¯ç”¨æ€§**: ğŸŸ¡ é«˜å¯ç”¨ (æµå¼è¾“å‡ºé—®é¢˜)
- **å¯è§‚æµ‹æ€§**: ğŸŸ¢ å®Œæ•´ç›‘æ§
- **å¯ç»´æŠ¤æ€§**: ğŸŸ¢ æ ‡å‡†åŒ–æ–‡æ¡£

---

## ğŸ¯ æ€»ç»“

**Week 5æˆåŠŸå®ç°äº†LLM Gatewayä»æ¼”ç¤ºçº§åˆ°ç”Ÿäº§çº§çš„å…³é”®è½¬å‹ã€‚**

### æ ¸å¿ƒæˆå°±
1. **ğŸš€ ç”Ÿäº§å°±ç»ª**: ä¼ä¸šçº§å®‰å…¨å’Œé…ç½®ç®¡ç†ä½“ç³»
2. **ğŸŒ çœŸå®é›†æˆ**: æ™ºè°±AIå®é™…APIè°ƒç”¨æˆåŠŸ
3. **ğŸ’° æˆæœ¬é€æ˜**: å®Œæ•´çš„æˆæœ¬è®¡ç®—å’Œæ§åˆ¶æœºåˆ¶
4. **ğŸ”„ é«˜å¯ç”¨æ€§**: æ™ºèƒ½é‡è¯•å’Œé”™è¯¯æ¢å¤æœºåˆ¶
5. **ğŸ“Š å®Œæ•´ç›‘æ§**: ç”Ÿäº§çº§æŒ‡æ ‡æ”¶é›†å’Œåˆ†æ

### æŠ€æœ¯çªç ´
- ä»Mocké€‚é…å™¨å‡çº§åˆ°çœŸå®APIé›†æˆ
- å»ºç«‹ä¼ä¸šçº§å®‰å…¨é…ç½®ç®¡ç†æ ‡å‡†
- å®ç°ç²¾ç¡®çš„Tokençº§åˆ«æˆæœ¬è®¡ç®—
- æä¾›å®Œæ•´çš„ç”Ÿäº§éƒ¨ç½²é…ç½®æ¨¡æ¿

**LLM Gatewayç°å·²å…·å¤‡æŠ•å…¥ç”Ÿäº§ç¯å¢ƒçš„æ ¸å¿ƒèƒ½åŠ›**ï¼Œä¸ºä¼ä¸šçº§éƒ¨ç½²å’Œå•†ä¸šåŒ–è¿è¥å¥ å®šäº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚

---

*å®Œæˆæ—¶é—´: 2025å¹´1æœˆ2æ—¥*  
*ç‰ˆæœ¬: Week5ç”Ÿäº§é€‚é…å™¨å®Œæ•´ç‰ˆ*  
*çŠ¶æ€: ç”Ÿäº§å°±ç»ª (é™¤æµå¼è¾“å‡ºå·²çŸ¥é—®é¢˜)* ğŸš€
